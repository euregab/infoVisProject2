<!DOCTYPE html>
<meta charset="utf-8">
<style type="text/css">

svg {
  font-family: "Helvetica Neue", Helvetica;
}

.line {
  fill: none;
  stroke: #000;
  stroke-width: 2px;
}

</style>
<body>



  
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3plus.org/js/d3plus.js"></script>


<script>

var m = [80, 80, 100, 80],
    w = 1060 - m[1] - m[3],
    h = 600 - m[0] - m[2];

var x,
    y,
    duration = 3000,
    delay = 500;

var color = d3.scale.category10();
var arrayTitoli = ["Line Graph","Stacked Graph","Stream Graph","Overlapping Areas","Grouped Bars","Stacked Bars","Bars","Donut"];

var rectWrap = ["Line Graph: disegna l'andamento dei ritardi in 5 grafici, uno per tipo di ritardo. Mappa nello spazio quindi un dato temporale  ed è di facile visualizzazione.","Stacked Graph: consente di osservare sulla stessa figura l'evoluzione del totale dei valori numerici e l'importanza relativa di ogni gruppo. Non sovrappone gli andamenti, ma li visualizza in succesione.","Stream Graph: una versione dello Stacked Area in cui le aree sono disposte lungo un asse orizzontale centrale. Questa differenza dà un effetto simile ad un flusso.","Overlapping Areas: Tipo di visualizzazione che fà sovrapporre l'andamento dei tipi di ritardo, accavallandoli e non facendoli visualizzare in successione come nello Stacked Graph.","GroupedBars: consente di confrontare, per ogni mese, ogni tipo di ritardo con gli altri.","StackedBars: efficace per mostrare la somma dei 5 tipi di ritardo per ogni mese, rappresentati da barre colorate poste una sopra l'altra.","   Bar Chart: questo grafico consente di fare paragoni su categorie discrete, rappresentate ognuna da una barra, la cui altezza simboleggia un valore numerico relativo a quella categoria.Qui l' asse delle ascisse è rappresentato dalla somma delle medie totali di ogni ritardo di ogni mese.   ","Donut :Il grafico Donut (noto anche come grafico a ciambella) è una variante di un grafico a torta tranne che ha un foro rotondo al centro che lo fa sembrare una ciambella, da cui il nome. Questo spazio vuoto può essere utilizzato per visualizzare dati aggiuntivi.Anche qui vengono visualizzate le somme delle medie totali dei ritardi di ogni mese."]


var svg = d3.select("body").append("svg")
.attr("id","svg")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
  .append("g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

    var svg_1 = d3.select("body").append("svg")
.attr("id","svg_1")
    .attr("width", w + m[1] + m[3])
    .attr("height",2*( h + m[0] + m[2]))
  .append("g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")")
   
   ;


var stocks,
    symbols,
    years;

// A line generator, for the dark stroke.
var line = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.delayValue); });

// A line generator, for the dark stroke.
var axis = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(h);

// A area generator, for the dark stroke.
var area = d3.svg.area()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y1(function(d) { return y(d.delayValue); });

d3.csv("../bigfile.csv", function(data) {
  var parse = d3.time.format("%Y %m").parse;

  // Nest stock values by delay.
  symbols = d3.nest()
      .key(function(d) { return d.delay; })
      .entries(stocks = data);

  // Parse dates and numbers. We assume values are sorted by date.
  // Also compute the maximum delayValue per delay, needed for the y-domain.
  symbols.forEach(function(s) {
    s.values.forEach(function(d) { d.date = parse(d.date); d.delayValue = +d.delayValue; });
    s.maxPrice = d3.max(s.values, function(d) { return d.delayValue; });
    s.sumPrice = d3.sum(s.values, function(d) { return d.delayValue; });
  });

  // Sort by maximum delayValue, descending.
  symbols.sort(function(a, b) { return b.maxPrice - a.maxPrice; });
  var dates = symbols[0].values.map(function(d) {return d.date});
  
  years = dates.map(function(d) {return d.getFullYear() + "/" + (+d.getMonth() + 1)})
  .filter(function(d, i){return i == 0 || (i + 1) % 6 == 0});
 
 
  var g = svg.selectAll("g")
      .data(symbols)
    .enter().append("g")
      .attr("class", "delay");

  setTimeout(lines, duration);//parto a disegnare
});
//-----------------------------------------------------FUNZIONI SUPPORTO------------------------------------------------------------------

function cambialclick(nome,duration,delay){

 setTimeout(nome,duration+delay)
};

var contatore = 0;


function titolo(intero){

 if(contatore < arrayTitoli.length){
d3.selectAll("#title").text(arrayTitoli[contatore]);
d3.selectAll("#rectWrap").text(rectWrap[contatore]);
d3plus.textwrap()
    .container(d3.select("#rectWrap"))
    .draw();
contatore +=1;
}else{
  contatore = 0;
}
};


svg.append("text").attr("id","title").attr("text-anchor","middle").style("font-size","38").attr("transform","translate("+((w/2))+",-20)");


svg_1.append("rect").attr("class","shape").attr("id","riquadro").attr("height",200).attr("width",900).attr("y",-80).attr("x",0).attr("opacity",0.0);
svg_1.append("text").attr("id","rectWrap").attr("class","wrap").attr("y",-80).attr("x",0).style("font-size","23");



function lines() {
d3.select("#riquadro").attr("opacity",0.1);
titolo(contatore);

  var maxRitardo = symbols[0].maxPrice;


  var xRange = d3.scale.ordinal().domain(years).rangePoints([0, w - 60]);
  var yRange = d3.scale.linear().domain([0,Math.round(maxRitardo *10)/10]).range([h , 0]);

  x = d3.time.scale().range([0, w - 60]);
  y = d3.scale.linear().range([h / 5 - 20, 0]);
  
  var y_axis = d3.svg.axis().scale(yRange).orient("left").tickFormat(function(d){return d3.format(".1f")(d/1)}).ticks(11);
  svg.append("g").attr("id", "y_axis").attr("opacity",0).call(y_axis);
  
  var x_axis = d3.svg.axis().scale(xRange);
  svg.append("g").attr("id", "x_axis").attr("transform", "translate(0," + h + ")").call(x_axis);

  // Compute the minimum and maximum date across symbols.
  x.domain([
    d3.min(symbols, function(d) { return d.values[0].date; }),
    d3.max(symbols, function(d) { return d.values[d.values.length - 1].date; })
  ]);

  var g = svg.selectAll(".delay")
      .attr("transform", function(d, i) { return "translate(0," + (i * h / 5 + 10) + ")"; });

  g.each(function(d) {
    var e = d3.select(this);

    e.append("path")
        .attr("class", "line");

    e.append("circle")
        .attr("r", 5)
        .style("fill", function(d) { return color(d.key); })
        .style("stroke", "#000")
        .style("stroke-width", "2px");

    e.append("text")
    .attr("id","pippo")
        .attr("x", 12)
        .attr("dy", ".31em")
        .text(d.key);
  });

  function draw(k) {
    g.each(function(d) {
      var e = d3.select(this);
      y.domain([0, d.maxPrice]);

      e.select("path")
          .attr("d", function(d) { return line(d.values.slice(0, k + 1)); });

      e.selectAll("circle, text")
          .data(function(d) { return [d.values[k], d.values[k]]; })
          .attr("transform", function(d) { return "translate(" + x(d.date) + "," + y(d.delayValue) + ")"; });
    });
  }

  var k = 1, n = symbols[0].values.length;
  d3.timer(function() {
    draw(k);
    if ((k += 2) >= n - 1) {
      draw(n-1);
     
      duration = 1;
      delay = 1;
      return true;
    }
  });
  d3.select("#svg").on("click",function(d,i){cambialclick(horizons,duration,delay)});
}

function horizons() {
 
  svg.selectAll("#pippo").attr("opacity",0);


  svg.insert("defs", ".delay")
    .append("clipPath")
      .attr("id", "clip")
    .append("rect")
      .attr("width", w)
      .attr("height", h / 5 - 20);

  var color = d3.scale.ordinal()
      .range(["#c6dbef", "#9ecae1", "#6baed6"]);

  var g = svg.selectAll(".delay")
      .attr("clip-path", "url(#clip)");

  area
      .y0(h / 5 - 20);

  g.select("circle").transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + (w - 60) + "," + (-h / 5) + ")"; })
      .remove();

  g.select("text").transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + (w - 60) + "," + (h / 5 - 20) + ")"; })
      .attr("dy", "0em");

  g.each(function(d) {
    y.domain([0, d.maxPrice]);

    d3.select(this).selectAll(".area")
        .data(d3.range(3))
      .enter().insert("path", ".line")
        .attr("class", "area")
        .attr("transform", function(d) { return "translate(0," + (d * (h / 5 - 20)) + ")"; })
        .attr("d", area(d.values))
        .style("fill", function(d, i) { return color(i); })
        .style("fill-opacity", 0);

    y.domain([0, d.maxPrice / 3]);

    d3.select(this).selectAll(".line").transition()
        .duration(duration)
        .attr("d", line(d.values))
        .style("stroke-opacity", 0);

    d3.select(this).selectAll(".area").transition()
        .duration(duration)
        .style("fill-opacity", 0)
        .attr("d", area(d.values))
        .each("end", function() { d3.select(this).style("fill-opacity", 0); });
  });

  setTimeout(areas,delay);
}

function areas() {
  var g = svg.selectAll(".delay");

  axis
      .y(h / 5 - 21);


      g.select("circle").transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + (w - 60) + "," + (-h / 5) + ")"; })
      .remove();

      g.select("text").transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + (w - 60) + "," + (h / 5 - 20) + ")"; })
      .attr("dy", "0em");

  g.select(".line")
      .attr("d", function(d) { return axis(d.values); });

  g.each(function(d) {
    y.domain([0, d.maxPrice]);

    d3.select(this).select(".line").transition()
        .duration(duration)
        .style("stroke-opacity", 0)
        .each("end", function() { d3.select(this).style("stroke-opacity", 0); });

    d3.select(this).selectAll(".area")
        .filter(function(d, i) { return i; })
      .transition()
        .duration(duration)
        .style("fill-opacity", 0)
        .attr("d", area(d.values))
        .remove();

    d3.select(this).selectAll(".area")
        .filter(function(d, i) { return !i; })
      .transition()
        .duration(duration)
        .style("fill", color(d.key))
        .attr("d", area(d.values));
  });

  svg.select("defs").transition()
      .duration(duration)
      .remove();

  g.transition()
      .duration(duration)
      .each("end", function() { d3.select(this).attr("clip-path", null); });

  setTimeout(stackedArea, duration + delay);
}

function stackedArea() {

  titolo(contatore);
  duration =100
  delay = 500
  svg.selectAll("#pippo").attr("opacity",1);
  d3.select(".line").style("stroke-opacity", 1);
  d3.selectAll(".area").style("fill-opacity", 1);

  var stack = d3.layout.stack()
      .values(function(d) { return d.values; })
      .x(function(d) { return d.date; })
      .y(function(d) { return d.delayValue; })
      .out(function(d, y0, y) { d.delay0 = y0; })
      .order("reverse");

  stack(symbols);

  y
      .domain([0, d3.max(symbols[0].values.map(function(d) { return d.delayValue + d.delay0; }))])
      .range([h, 0]);

  line
      .y(function(d) { return y(d.delay0); });

  area
      .y0(function(d) { return y(d.delay0); })
      .y1(function(d) { return y(d.delay0 + d.delayValue); });

  var t = svg.selectAll(".delay").transition()
      .duration(duration)
      .attr("transform", "translate(0,0)")
      .each("end", function() { d3.select(this).attr("transform", null); });

  t.select("path.area")
      .attr("d", function(d) { return area(d.values); });

  t.select("path.line")
      .style("stroke-opacity", 1)
      .attr("d", function(d) { return line(d.values); });

  t.select("text")
      .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.delayValue / 2 + d.delay0) + ")"; });
      
      d3.select("#svg").on("click",function(d,i){cambialclick(streamgraph,duration,delay)});

}

function streamgraph() {
  titolo(contatore);
  var stack = d3.layout.stack()
      .values(function(d) { return d.values; })
      .x(function(d) { return d.date; })
      .y(function(d) { return d.delayValue; })
      .out(function(d, y0, y) { d.delay0 = y0; })
      .order("reverse")
      .offset("wiggle");

  stack(symbols);

  line
      .y(function(d) { return y(d.delay0); });

  var t = svg.selectAll(".delay").transition()
      .duration(duration);

  t.select("path.area")
      .attr("d", function(d) { return area(d.values); });

  t.select("path.line")
      .style("stroke-opacity", 0)
      .attr("d", function(d) { return line(d.values); });

  t.select("text")
      .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.delayValue / 2 + d.delay0) + ")"; });
      
    
      d3.select("#svg").on("click",function(d,i){cambialclick(overlappingArea,1,1)});
}

function overlappingArea() {

  titolo(contatore);
  d3.selectAll("text").style("opacity", 1);
  d3.selectAll("#y_axis").style("opacity", 1);
  var g = svg.selectAll(".delay");

  line
      .y(function(d) { return y(d.delay0 + d.delayValue); });

  g.select(".line")
      .attr("d", function(d) { return line(d.values); });

  y
      .domain([0, d3.max(symbols.map(function(d) { return d.maxPrice; }))])
      .range([h, 0]);

  area
      .y0(h)
      .y1(function(d) { return y(d.delayValue); });

  line
      .y(function(d) { return y(d.delayValue); });

  var t = g.transition()
      .duration(duration);

  t.select(".line")
      .style("stroke-opacity", 1)
      .attr("d", function(d) { return line(d.values); });

  t.select(".area")
      .style("fill-opacity", .5)
      .attr("d", function(d) { return area(d.values); });

  t.select("text")
      .attr("dy", ".31em")
      .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.delayValue) + ")"; });

  svg.append("line")
      .attr("class", "line")
      .attr("x1", 0)
      .attr("x2", w - 60)
      .attr("y1", h)
      .attr("y2", h)
      .style("stroke-opacity", 1e-6)
    .transition()
      .duration(duration)
      .style("stroke-opacity", 1);


      duration = 300;
      delay = 500;
      d3.select("#svg").on("click",function(d,i){cambialclick(groupedBar,1,1)});
}

function groupedBar() {

  titolo(contatore);
  x = d3.scale.ordinal()
      .domain(symbols[0].values.map(function(d) { return d.date; }))
      .rangeBands([0, w - 60], .1);

  var x1 = d3.scale.ordinal()
      .domain(symbols.map(function(d) { return d.key; }))
      .rangeBands([0, x.rangeBand()]);

  var g = svg.selectAll(".delay");

  var t = g.transition()
      .duration(duration);

  t.select(".line")
      .style("stroke-opacity", 1e-6)
      .remove();

  t.select(".area")
      .style("fill-opacity", 1e-6)
      .remove();

  g.each(function(p, j) {
    d3.select(this).selectAll("rect")
        .data(function(d) { return d.values; })
      .enter().append("rect")
        .attr("x", function(d) { return x(d.date) + x1(p.key); })
        .attr("y", function(d) { return y(d.delayValue); })
        .attr("width", x1.rangeBand())
        .attr("height", function(d) { return h - y(d.delayValue); })
        .style("fill", color(p.key))
        .style("fill-opacity", 1e-6)
      .transition()
        .duration(duration)
        .style("fill-opacity", 1);
  });

  d3.select("#svg").on("click",function(d,i){cambialclick(stackedBar,1,1)});
}

function stackedBar() {

  titolo(contatore);
 
  d3.select("#y_axis").remove();
  x.rangeRoundBands([0, w - 60], 0);

  var stack = d3.layout.stack()
      .values(function(d) { return d.values; })
      .x(function(d) { return d.date; })
      .y(function(d) { return d.delayValue; })
      .out(function(d, y0, y) { d.delay0 = y0; })
      .order("reverse");

  var g = svg.selectAll(".delay");

  stack(symbols);

  y
      .domain([0, d3.max(symbols[0].values.map(function(d) { return d.delayValue + d.delay0; }))])
      .range([h, 0]);

  var t = g.transition()
      .duration(duration / 2);

  t.select("text")
      .delay(symbols[0].values.length * 10)
      .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.delayValue / 2 + d.delay0) + ")"; });

  t.selectAll("rect")
      .delay(function(d, i) { return i * 10; })
      .attr("y", function(d) { return y(d.delay0 + d.delayValue); })
      .attr("height", function(d) { return h - y(d.delayValue); })
      .each("end", function() {
        d3.select(this)
            .style("stroke", "#fff")
            .style("stroke-opacity", 1e-6)
          .transition()
            .duration(duration / 2)
            .attr("x", function(d) { return x(d.date); })
            .attr("width", x.rangeBand())
            .style("stroke-opacity", 1);
      });

      d3.select("#svg").on("click",function(d,i){cambialclick(transposeBar,duration  ,delay)});
}

function transposeBar() {

  titolo(contatore);
  
  yRange1 = d3.scale.linear().domain([0, d3.max(symbols.map(function(d) { return d3.sum(d.values.map(function(d) { return d.delayValue; })); }))]).range([h , 0]);
  y_axis1 = d3.svg.axis().scale(yRange1).orient("left").tickFormat(function(d){return d3.format(".1f")(d/1)}).ticks(11);
  svg.append("g").attr("id", "y_axis1").attr("opacity",1).call(y_axis1);
  
  
  
  
  d3.select("#x_axis").attr("opacity",0);
  x
      .domain(symbols.map(function(d) { return d.key; }))
      .rangeRoundBands([0, w-50], .2);

  y
      .domain([0, d3.max(symbols.map(function(d) { return d3.sum(d.values.map(function(d) { return d.delayValue; })); }))]);

  var stack = d3.layout.stack()
      .x(function(d, i) { return i; })
      .y(function(d) { return d.delayValue; })
      .out(function(d, y0, y) { d.delay0 = y0; });

  stack(d3.zip.apply(null, symbols.map(function(d) { return d.values; }))); // transpose!

  var g = svg.selectAll(".delay");

  var t = g.transition()
      .duration(duration / 2);

  t.selectAll("rect")
      .delay(function(d, i) { return i * 10; })
      .attr("y", function(d) { return y(d.delay0 + d.delayValue) - 1; })
      .attr("height", function(d) { return h - y(d.delayValue) + 1; })
      .attr("x", function(d) { return x(d.delay); })
      .attr("width", x.rangeBand())
      .style("stroke-opacity", 1e-6);

  t.select("text")
      .attr("x", 0)
      .attr("transform", function(d) { return "translate(" + (x(d.key) + x.rangeBand() / 2) + "," + h + ")"; })
      .attr("dy", "1.31em")
      .each("end", function() { d3.select(this).attr("x", null).attr("text-anchor", "middle"); });

  svg.select("line").transition()
      .duration(duration)
      .attr("x2", w);

      d3.select("#svg").on("click",function(d,i){cambialclick(donut,duration ,delay)});
}

function donut() {


  titolo(contatore);
  d3.select("#y_axis1").remove();
  d3.select("#y_axis").attr("opacity",0);
  
  
  var g = svg.selectAll(".delay");
  d3.selectAll(".line").attr("opacity",0);
  g.selectAll("rect").remove();

  var pie = d3.layout.pie()
      .value(function(d) { return d.sumPrice; });

  var arc = d3.svg.arc();

  g.append("path")
      .style("fill", function(d) { return color(d.key); })
      .data(function() { return pie(symbols); })
    .transition()
      .duration(duration+1000)
      .tween("arc", arcTween);

  g.select("text").transition()
      .duration(duration)
      .attr("dy", ".31em");

  svg.select("line").transition()
      .duration(duration)
      .attr("y1", 2 * h)
      .attr("y2", 2 * h)
      .remove();

  function arcTween(d) {
    var path = d3.select(this),
        text = d3.select(this.parentNode.appendChild(this.previousSibling)),
        x0 = x(d.data.key),
        y0 = h - y(d.data.sumPrice);

    return function(t) {
      var r = h / 2 / Math.min(1, t + 1e-3),
          a = Math.cos(t * Math.PI / 2),
          xx = (-r + (a) * (x0 + x.rangeBand()) + (1 - a) * (w + h) / 2),
          yy = ((a) * h + (1 - a) * h / 2),
          f = {
            innerRadius: r - x.rangeBand() / (2 - a),
            outerRadius: r,
            startAngle: a * (Math.PI / 2 - y0 / r) + (1 - a) * d.startAngle,
            endAngle: a * (Math.PI / 2) + (1 - a) * d.endAngle
          };

      path.attr("transform", "translate(" + xx + "," + yy + ")");
      path.attr("d", arc(f));
      text.attr("transform", "translate(" + arc.centroid(f) + ")translate(" + xx + "," + yy + ")rotate(" + ((f.startAngle + f.endAngle) / 2 + 3 * Math.PI / 2) * 180 / Math.PI + ")");
    };
  }

  d3.select("#svg").on("click",function(d,i){cambialclick(donutExplode,duration ,delay)});
}

function donutExplode() {
  d3.selectAll("#title").remove();
  d3.selectAll("#rectWrap").remove();
  d3.select("#riquadro").remove();
 
  var r0a = h / 2 - x.rangeBand() / 2,
      r1a = h / 2,
      r0b = 2 * h - x.rangeBand() / 2,
      r1b = 2 * h,
      arc = d3.svg.arc();

  svg.selectAll(".delay path")
      .each(transitionExplode);

  function transitionExplode(d, i) {
    d.innerRadius = r0a;
    d.outerRadius = r1a;
    d3.select(this).transition()
        .duration(duration +1000)
        .tween("arc", tweenArc({
          innerRadius: r0b,
          outerRadius: r1b
        }));
  }

  function tweenArc(b) {
    return function(a) {
      var path = d3.select(this),
          text = d3.select(this.nextSibling),
          i = d3.interpolate(a, b);
      for (var key in b) a[key] = b[key]; // update data
      return function(t) {
        var a = i(t);
        path.attr("d", arc(a));
        text.attr("transform", "translate(" + arc.centroid(a) + ")translate(" + w / 2 + "," + h / 2 +")rotate(" + ((a.startAngle + a.endAngle) / 2 + 3 * Math.PI / 2) * 180 / Math.PI + ")");
      };
    }
  }

  setTimeout(function() {
    svg.selectAll("*").remove();
    svg_1.selectAll("*").remove();
    contatore =0;
    svg.selectAll("g").data(symbols).enter().append("g").attr("class", "delay");
    svg.append("text").attr("id","title").attr("text-anchor","middle").style("font-size","38").attr("transform","translate("+((w/2))+",-20)");
    
    svg_1.append("rect").attr("class","shape").attr("id","riquadro").attr("height",200).attr("width",900).attr("y",-80).attr("x",0).attr("opacity",0.0);
    svg_1.append("text").attr("id","rectWrap").attr("class","wrap").attr("y",-80).attr("x",0).style("font-size","23");
    lines();
  }, duration+1000);
}

</script>